# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.

GTEST_DIR = /mp/nas1/share/lib/googletest/googletest

CPPFLAGS += -std=c++11 -isystem $(GTEST_DIR)/include
CXXFLAGS += -g -Wall -Wextra -pthread

CUDA_INC = /usr/local/cuda/include
CUDA_LIB = /usr/local/cuda/lib64
MEX_INC = /usr/local/MATLAB/R2017a/extern/include

SPDLOG_DIR = ../../include

UTILS_DIR = ../utils
CUDAUTILS_DIR = ../cuda-utils
MEXUTILS_DIR = ../mex-utils

TESTS = gtest_utils gtest_cudautils gtest_quantilenorm_cuda_impl gtest_radixsort_gpu_stresstest

GTEST_HEADERS = $(GTEST_DIR)/include/gtest/*.h \
                $(GTEST_DIR)/include/gtest/internal/*.h


all : $(TESTS)

clean :
	rm -f $(TESTS) *.o


gtest_utils.o : gtest_utils.cpp $(GTEST_HEADERS)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -I$(UTILS_DIR) -c gtest_utils.cpp

gtest_utils : gtest_utils.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $(GTEST_DIR)/libgtest_main.a $(GTEST_DIR)/libgtest.a -lpthread $^ -o $@ -L$(UTILS_DIR) -lutils


gtest_cudautils.o : gtest_cudautils.cpp $(GTEST_HEADERS)
	nvcc $(CPPFLAGS) -I$(CUDAUTILS_DIR) -I$(SPDLOG_DIR) -c gtest_cudautils.cpp

gtest_cudautils : gtest_cudautils.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $^ $(GTEST_DIR)/libgtest_main.a $(GTEST_DIR)/libgtest.a -lpthread -o $@ -L$(CUDAUTILS_DIR) -lcudautils -L$(CUDA_LIB) -lcudart -ltbb


quantilenorm_cuda_impl.o : ../quantilenorm_impl.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -I.. -I$(MEX_INC) -I$(SPDLOG_DIR) -I$(CUDA_INC) -c -o $@ $^

gtest_quantilenorm_cuda_impl.o : gtest_quantilenorm_cuda_impl.cpp $(GTEST_HEADERS)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -I.. -I$(UTILS_DIR) -I$(SPDLOG_DIR) -c gtest_quantilenorm_cuda_impl.cpp

gtest_quantilenorm_cuda_impl : quantilenorm_cuda_impl.o gtest_quantilenorm_cuda_impl.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $^ $(GTEST_DIR)/libgtest_main.a $(GTEST_DIR)/libgtest.a -lpthread -o $@ -L$(UTILS_DIR) -lutils -L$(CUDAUTILS_DIR) -lcudautils -L$(CUDA_LIB) -lcudart -ltbb


gtest_radixsort_gpu_stresstest.o : gtest_radixsort_gpu_stresstest.cpp
	nvcc $(CPPFLAGS) -I$(CUDA_INC) -I$(CUDAUTILS_DIR) -I$(SPDLOG_DIR) -c gtest_radixsort_gpu_stresstest.cpp

gtest_radixsort_gpu_stresstest : gtest_radixsort_gpu_stresstest.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $^ $(GTEST_DIR)/libgtest_main.a $(GTEST_DIR)/libgtest.a -lpthread -o $@ -L$(CUDAUTILS_DIR) -lcudautils -L$(CUDA_LIB) -lcudart -ltbb
